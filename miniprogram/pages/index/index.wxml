<view class="container">
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <view class="dynamic-bg">
    <view class="bg-gradient" style="background: linear-gradient(180deg, {{theme.bgGradient[0]}} 0%, {{theme.bgGradient[1]}} 60%, {{theme.bgGradient[2]}} 100%);"></view>
    <!-- åŠ¨æ€è£…é¥°å…ƒç´  -->
    <view class="decorations">
      <view 
        wx:for="{{theme.blobs}}" 
        wx:key="index"
        class="blob blob-{{index}}"
        style="background: {{item}}; animation-delay: {{index * 2}}s;"
      ></view>
      <!-- æ—¶é—´ä¸“å±å›¾æ¡ˆ -->
      <view class="time-element element-{{theme.key}}">
        <text>{{theme.emoji}}</text>
      </view>
    </view>
  </view>
  
  <!-- æµ‹è¯•åˆ‡æ¢æŒ‰é’® -->
  <view class="debug-panel">
    <view class="debug-btn" bindtap="toggleTheme">åˆ‡æ¢</view>
    <view class="theme-list">
      <view 
        wx:for="{{themeList}}" 
        wx:key="key"
        class="theme-item {{theme.key === item.key ? 'active' : ''}}"
        style="background: {{item.bgGradient[1]}};"
        bindtap="setTheme"
        data-key="{{item.key}}"
      >
        <text>{{item.emoji}}</text>
      </view>
    </view>
  </view>
  
  <!-- ä¸»å†…å®¹ -->
  <view class="main-content">
    <!-- æ—¶é—´æ ‡è¯† -->
    <view class="time-badge" style="color: {{theme.textPrimary}};">
      <text>{{theme.emoji}}</text>
      <text class="time-name" style="color: {{theme.textSecondary}};">{{theme.name}}</text>
    </view>
    
    <!-- æ—¥æœŸ -->
    <view class="date-display">
      <text class="month" style="color: {{theme.textSecondary}};">{{month}}</text>
      <text class="day" style="-webkit-text-fill-color: {{theme.textPrimary}}; color: {{theme.textPrimary}};">{{day}}</text>
    </view>
    
    <!-- é—®å€™ -->
    <view class="greeting">
      <text class="greeting-text" style="color: {{theme.textPrimary}};">{{theme.greeting}}</text>
    </view>
    
    <!-- æ‰“å¡æŒ‰é’® -->
    <view class="button-wrapper">
      <view class="bubble-btn" style="--primary: {{theme.primary}};" bindtap="onAddClick">
        <!-- ä¸»æ³¡æ³¡ -->
        <view class="bubble-main"></view>
        <!-- é«˜å…‰ -->
        <view class="bubble-shine"></view>
        <!-- æŒ‰é’®å†…å®¹ -->
        <view class="btn-content">
          <view class="camera-icon">
            <view class="camera-body"></view>
            <view class="camera-lens"></view>
            <view class="camera-flash"></view>
          </view>
          <text class="btn-hint">æ‹ç…§æ‰“å¡</text>
        </view>
      </view>
    </view>
    
    <!-- ä»Šæ—¥æ‰“å¡çŠ¶æ€ -->
    <view class="meal-status">
      <view 
        wx:for="{{todayMeals}}" 
        wx:key="key"
        class="meal-icon-item {{item.checked ? 'checked' : ''}}"
        style="{{item.checked ? '--active-color:' + item.color : ''}}"
        bindtap="onMealIconTap"
        data-key="{{item.key}}"
      >
        <view class="meal-icon-bg" style="background: {{item.checked ? item.color : 'rgba(255,255,255,0.3)'}};">
          <text class="meal-icon-emoji">{{item.emoji}}</text>
        </view>
        <text class="meal-icon-label" style="color: {{item.checked ? theme.textPrimary : theme.textSecondary}};">{{item.label}}</text>
      </view>
    </view>
  </view>
  
  <!-- æ‰“å¡è¯¦æƒ…å¼¹çª— -->
  <view class="popup-mask {{showMealPopup ? 'show' : ''}}" bindtap="onClosePopup"></view>
  <view class="popup-modal {{showMealPopup ? 'show' : ''}}">
    <view class="popup-content" wx:if="{{popupRecord}}">
      <view class="popup-image-list">
        <view wx:for="{{popupRecord.imageUrl}}" wx:key="index" class="popup-image-wrapper">
          <image 
            class="popup-image" 
            src="{{item}}" 
            mode="aspectFill"
          ></image>
        </view>
      </view>
      <view class="popup-info">
        <view class="popup-meal-tag" style="background: linear-gradient(135deg, {{popupMealInfo.color}} 0%, {{popupMealInfo.color}}CC 100%);">
          <text>{{popupMealInfo.emoji}}</text>
          <text>{{popupMealInfo.label}}</text>
        </view>
        <text class="popup-time">{{popupFormattedTime}}</text>
      </view>
      <view class="popup-actions">
        <view class="popup-action-btn" bindtap="onSharePoster">
          <text class="action-icon">ğŸ–¼ï¸</text>
          <text class="action-text">ç”Ÿæˆæµ·æŠ¥</text>
        </view>
        <button 
          class="popup-action-btn share-btn" 
          open-type="share"
          data-id="{{popupRecord.id}}"
          data-shareid="{{popupRecord.shareId}}"
          data-title="{{popupRecord.title}}"
        >
          <text class="action-icon">ğŸ“¤</text>
          <text class="action-text">åˆ†äº«å¥½å‹</text>
        </button>
      </view>
    </view>
  </view>

  <!-- æ‹ç…§å¼¹çª— -->
  <view class="camera-popup {{showCameraPopup ? 'show' : ''}}">
    <!-- è°ƒæ•´å›¾ç‰‡å¼¹çª— -->
    <view class="adjust-popup {{isAdjustingPhoto ? 'show' : ''}}">
      <view class="adjust-viewport">
        <view class="adjust-frame">
          <image 
            class="adjust-image" 
            src="{{cameraPhotos[adjustPhotoIndex]}}"
            mode="aspectFill"
            style="transform: translate({{adjustX}}px, {{adjustY}}px) scale({{adjustScale}});"
            bindtouchstart="onTouchAdjustStart"
            bindtouchmove="onTouchAdjustMove"
            bindtouchend="onTouchAdjustEnd"
          ></image>
          <view class="adjust-mask"></view>
          <view class="adjust-corner tl"></view>
          <view class="adjust-corner tr"></view>
          <view class="adjust-corner bl"></view>
          <view class="adjust-corner br"></view>
        </view>
        <view class="adjust-hint">
          <text>åŒæŒ‡ç¼©æ”¾ï¼Œå•æŒ‡æ‹–åŠ¨</text>
        </view>
      </view>
      <view class="adjust-controls">
        <view class="adjust-btn cancel" bindtap="onCancelAdjust">å–æ¶ˆ</view>
        <view class="adjust-btn confirm" bindtap="onConfirmAdjust">å®Œæˆ</view>
      </view>
    </view>

    <!-- å…³é—­æŒ‰é’® - å·¦ä¸Šè§’ -->
    <view class="camera-close-btn" bindtap="onCloseCameraPopup">
      <text>âœ•</text>
    </view>

    <!-- å–æ™¯æ¡† -->
    <view class="camera-viewfinder" wx:if="{{showCameraPopup}}">
      <view class="viewfinder-frame" wx:if="{{!isAdjustingPhoto}}">
        <camera 
          device-position="back" 
          flash="off" 
          class="camera-element"
        ></camera>
        <view class="frame-corner tl"></view>
        <view class="frame-corner tr"></view>
        <view class="frame-corner bl"></view>
        <view class="frame-corner br"></view>
      </view>
    </view>

    <!-- åº•éƒ¨é¢æ¿ -->
    <view class="camera-bottom-panel">
      <!-- ç…§ç‰‡é¢„è§ˆ - æ¨ªå‘æ’åˆ— -->
      <view class="photo-thumbnail-list">
        <scroll-view scroll-x class="thumbnail-scroll" enhanced show-scrollbar="{{false}}">
          <view 
            wx:for="{{cameraPhotos}}" 
            wx:key="index"
            class="thumbnail-item"
          >
            <image class="thumbnail-img" src="{{item}}" mode="aspectFill" bindtap="onStartAdjustPhoto" data-index="{{index}}"></image>
            <view class="thumbnail-delete" catchtap="onDeletePhoto" data-index="{{index}}">âœ•</view>
          </view>
        </scroll-view>
      </view>

      <!-- é¤åˆ«é€‰æ‹© -->
      <view class="camera-meal-section">
        <text class="camera-section-title">é€‰æ‹©é¤åˆ«</text>
        <view class="camera-meal-scroll">
          <view class="camera-meal-list">
            <view 
              wx:for="{{cameraMealTypes}}" 
              wx:key="key"
              class="camera-meal-item {{cameraMealType === item.key ? 'selected' : ''}}"
              style="{{cameraMealType === item.key ? '--active-color:' + item.color : ''}}"
              bindtap="onCameraMealTap"
              data-key="{{item.key}}"
            >
              <view class="camera-meal-icon" style="background: {{cameraMealType === item.key ? item.color : 'rgba(255,255,255,0.12)'}};">
                <text class="camera-meal-emoji">{{item.emoji}}</text>
              </view>
              <text class="camera-meal-label">{{item.label}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ ‡é¢˜ -->
      <view class="camera-title-section" bindtap="onCameraTitleTap">
        <text class="camera-section-title">æ ‡é¢˜</text>
        <view class="camera-title-bar">
          <text class="camera-title-text">{{cameraTitle}}</text>
          <view class="camera-title-edit">
            <text>ç¼–è¾‘</text>
            <view class="arrow-right"></view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æ§åˆ¶æ  -->
      <view class="camera-controls">
        <view class="control-btn" bindtap="onChooseFromAlbum">
          <view class="control-icon-wrapper">
            <text class="control-icon">ğŸ–¼ï¸</text>
          </view>
          <text class="control-label">ç›¸å†Œ</text>
        </view>
        <view class="capture-wrapper">
          <view class="capture-btn" bindtap="onTakePhoto">
            <view class="capture-inner"></view>
          </view>
        </view>
        <view class="control-btn {{cameraPhotos.length > 0 ? '' : 'disabled'}}" bindtap="onSavePhotos">
          <view class="control-icon-wrapper">
            <text class="control-icon">âœ”</text>
          </view>
          <text class="control-label">ä¿å­˜</text>
        </view>
      </view>
    </view>

    <!-- ä¸Šä¼ çŠ¶æ€é®ç½© -->
    <view class="camera-upload-overlay" wx:if="{{isUploading || uploadProgress}}">
      <view class="upload-card">
        <view class="spinner-wrapper">
          <view class="spinner" wx:if="{{isUploading}}"></view>
          <text class="success-icon" wx:if="{{!isUploading && uploadProgress === 'ä¸Šä¼ å®Œæˆ'}}">âœ“</text>
        </view>
        <text class="status-text">{{uploadProgress || 'ä¸Šä¼ ä¸­...'}}</text>
        <text class="retry-text" wx:if="{{uploadProgress === 'ä¸Šä¼ å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•'}}" bindtap="onRetryUpload">ç‚¹å‡»é‡è¯•</text>
      </view>
    </view>
  </view>

  <!-- éšè—çš„ canvas ç”¨äºè£å‰ª -->
  <canvas canvas-id="photoCropper" width="{{cropCanvasSize}}" height="{{cropCanvasSize}}" style="width: {{cropCanvasSize}}px; height: {{cropCanvasSize}}px; position: absolute; left: -9999px; top: -9999px;" />
  <!-- éšè—çš„ canvas ç”¨äºæµ·æŠ¥ -->
  <view class="poster-canvas-container">
    <canvas type="2d" id="posterCanvas" style="width: 320px; height: 480px;"></canvas>
  </view>
</view>
