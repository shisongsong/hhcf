<view class="container">
  <!-- åŠ¨æ€èƒŒæ™¯ -->
  <view class="dynamic-bg">
    <view class="bg-gradient" style="background: linear-gradient(180deg, {{theme.bgGradient[0]}} 0%, {{theme.bgGradient[1]}} 60%, {{theme.bgGradient[2]}} 100%);"></view>
    <!-- åŠ¨æ€è£…é¥°å…ƒç´  -->
    <view class="decorations">
      <view 
        wx:for="{{theme.blobs}}" 
        wx:key="index"
        class="blob blob-{{index}}"
        style="background: {{item}}; animation-delay: {{index * 2}}s;"
      ></view>
      <!-- æ—¶é—´ä¸“å±å›¾æ¡ˆ -->
      <view class="time-element element-{{theme.key}}">
        <text>{{theme.emoji}}</text>
      </view>
    </view>
  </view>
  
  <!-- æµ‹è¯•åˆ‡æ¢æŒ‰é’® -->
  <view class="debug-panel">
    <view class="debug-btn" bindtap="toggleTheme">åˆ‡æ¢</view>
    <view class="theme-list">
      <view 
        wx:for="{{themeList}}" 
        wx:key="key"
        class="theme-item {{theme.key === item.key ? 'active' : ''}}"
        style="background: {{item.bgGradient[1]}};"
        bindtap="setTheme"
        data-key="{{item.key}}"
      >
        <text>{{item.emoji}}</text>
      </view>
    </view>
  </view>
  
  <!-- ä¸»å†…å®¹ -->
  <view class="main-content">
    <!-- æ—¶é—´æ ‡è¯† -->
    <view class="time-badge" style="color: {{theme.textPrimary}};">
      <text>{{theme.emoji}}</text>
      <text class="time-name" style="color: {{theme.textSecondary}};">{{theme.name}}</text>
    </view>
    
    <!-- æ—¥æœŸ -->
    <view class="date-display">
      <text class="month" style="color: {{theme.textSecondary}};">{{month}}</text>
      <text class="day" style="-webkit-text-fill-color: {{theme.textPrimary}}; color: {{theme.textPrimary}};">{{day}}</text>
    </view>
    
    <!-- é—®å€™ -->
    <view class="greeting">
      <text class="greeting-text" style="color: {{theme.textPrimary}};">{{theme.greeting}}</text>
    </view>
    
    <!-- æ‰“å¡æŒ‰é’® -->
    <view class="button-wrapper">
      <view class="bubble-btn" style="--primary: {{theme.primary}};" bindtap="onAddClick">
        <!-- ä¸»æ³¡æ³¡ -->
        <view class="bubble-main"></view>
        <!-- é«˜å…‰ -->
        <view class="bubble-shine"></view>
        <!-- æŒ‰é’®å†…å®¹ -->
        <view class="btn-content">
          <view class="camera-icon">
            <view class="camera-body"></view>
            <view class="camera-lens"></view>
            <view class="camera-flash"></view>
          </view>
          <text class="btn-hint">æ‹ç…§æ‰“å¡</text>
        </view>
      </view>
    </view>
    
    <!-- ä»Šæ—¥æ‰“å¡çŠ¶æ€ -->
    <view class="meal-status">
      <view 
        wx:for="{{todayMeals}}" 
        wx:key="key"
        class="meal-icon-item {{item.checked ? 'checked' : ''}}"
        style="{{item.checked ? '--active-color:' + item.color : ''}}"
        bindtap="onMealIconTap"
        data-key="{{item.key}}"
      >
        <view class="meal-icon-bg" style="background: {{item.checked ? item.color : 'rgba(255,255,255,0.3)'}};">
          <text class="meal-icon-emoji">{{item.emoji}}</text>
        </view>
        <text class="meal-icon-label" style="color: {{item.checked ? theme.textPrimary : theme.textSecondary}};">{{item.label}}</text>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨å¯¼èˆª -->
  <view class="bottom-nav">
    <view class="nav-item" style="color: {{theme.textSecondary}};" bindtap="goToRecords">
      <text class="nav-icon">ğŸ“‹</text>
      <text class="nav-text" style="color: {{theme.textSecondary}};">è®°å½•</text>
    </view>
  </view>
  
  <!-- æ‰“å¡è¯¦æƒ…å¼¹çª— -->
  <view class="popup-mask {{showMealPopup ? 'show' : ''}}" bindtap="onClosePopup"></view>
  <view class="popup-modal {{showMealPopup ? 'show' : ''}}">
    <view class="popup-content" wx:if="{{popupRecord}}">
      <view class="popup-image-list">
        <image 
          wx:for="{{popupRecord.imageUrl}}" 
          wx:key="index"
          class="popup-image" 
          src="{{item}}" 
          mode="aspectFill"
        ></image>
      </view>
      <view class="popup-info">
        <view class="popup-meal-tag" style="background: linear-gradient(135deg, {{popupMealInfo.color}} 0%, {{popupMealInfo.color}}CC 100%);">
          <text>{{popupMealInfo.emoji}}</text>
          <text>{{popupMealInfo.label}}</text>
        </view>
        <text class="popup-time">{{popupFormattedTime}}</text>
      </view>
      <view class="popup-actions">
        <view class="popup-action-btn" bindtap="onSharePoster">
          <text class="action-icon">ğŸ–¼ï¸</text>
          <text class="action-text">ç”Ÿæˆæµ·æŠ¥</text>
        </view>
        <view class="popup-action-btn" bindtap="onShareMiniApp">
          <text class="action-icon">ğŸ“¤</text>
          <text class="action-text">åˆ†äº«å¥½å‹</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‹ç…§å¼¹çª— -->
  <view class="camera-popup {{showCameraPopup ? 'show' : ''}}">
    <view class="camera-header">
      <view class="camera-close" bindtap="onCloseCameraPopup">
        <text>âœ•</text>
      </view>
      <text class="camera-title">æ‹ç…§æ‰“å¡</text>
      <view class="camera-placeholder"></view>
    </view>

    <!-- è°ƒæ•´å›¾ç‰‡å¼¹çª— -->
    <view class="adjust-popup {{isAdjustingPhoto ? 'show' : ''}}">
      <view class="adjust-content">
        <view class="adjust-preview">
          <image 
            class="adjust-image" 
            src="{{cameraPhotos[adjustPhotoIndex]}}"
            mode="aspectFill"
            style="transform: scale({{adjustScale}}) translate({{adjustX}}rpx, {{adjustY}}rpx);"
          ></image>
          <view class="adjust-mask-top"></view>
          <view class="adjust-mask-bottom"></view>
          <view class="adjust-mask-left"></view>
          <view class="adjust-mask-right"></view>
        </view>
        <view class="adjust-controls">
          <view class="adjust-control">
            <text>ç¼©æ”¾: {{adjustScale.toFixed(1)}}x</text>
            <slider min="50" max="150" value="{{adjustScale * 50}}" bindchange="onAdjustScaleChange" />
          </view>
          <view class="adjust-control">
            <text>æ°´å¹³ç§»åŠ¨</text>
            <slider min="0" max="200" value="{{adjustX + 100}}" bindchange="onAdjustXChange" />
          </view>
          <view class="adjust-control">
            <text>å‚ç›´ç§»åŠ¨</text>
            <slider min="0" max="200" value="{{adjustY + 100}}" bindchange="onAdjustYChange" />
          </view>
          <view class="adjust-btns">
            <view class="adjust-btn cancel" bindtap="onCancelAdjust">å–æ¶ˆ</view>
            <view class="adjust-btn confirm" bindtap="onConfirmAdjust">ç¡®å®š</view>
          </view>
        </view>
      </view>
    </view>

    <!-- å–æ™¯æ¡† -->
    <view class="camera-viewfinder">
      <camera 
        device-position="back" 
        flash="off" 
        class="camera-element"
      ></camera>
      <view class="viewfinder-frame">
        <view class="frame-corner tl"></view>
        <view class="frame-corner tr"></view>
        <view class="frame-corner bl"></view>
        <view class="frame-corner br"></view>
      </view>
    </view>

    <!-- ç…§ç‰‡é¢„è§ˆ -->
    <view class="photo-thumbnail-list" wx:if="{{cameraPhotos.length > 0}}">
      <scroll-view scroll-x class="thumbnail-scroll">
        <view 
          wx:for="{{cameraPhotos}}" 
          wx:key="index"
          class="thumbnail-item {{currentCameraIndex === index ? 'active' : ''}}"
        >
          <image class="thumbnail-img" src="{{item}}" mode="aspectFill" bindtap="onStartAdjustPhoto" data-index="{{index}}"></image>
          <view class="thumbnail-delete" bindtap="onDeletePhoto" data-index="{{index}}">âœ•</view>
        </view>
      </scroll-view>
    </view>

    <!-- åº•éƒ¨æ§åˆ¶æ  -->
    <view class="camera-controls">
      <view class="control-btn album" bindtap="onChooseFromAlbum">
        <text>ğŸ“·</text>
      </view>
      <view class="control-btn capture" bindtap="onTakePhoto">
        <view class="capture-btn"></view>
      </view>
      <view class="control-btn save {{cameraPhotos.length === 0 ? 'disabled' : ''}}" bindtap="onSavePhotos">
        <text>âœ“</text>
      </view>
    </view>
  </view>

  <!-- éšè—çš„ canvas ç”¨äºè£å‰ª -->
  <canvas canvas-id="cropCanvas" style="width: 600px; height: 600px; position: absolute; left: -9999px;"></canvas>
</view>
